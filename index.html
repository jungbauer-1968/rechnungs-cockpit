<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rechnungs-Cockpit</title>

<style>
   
/* ---------------------------------------------------------
   ROOT COLORS
--------------------------------------------------------- */
:root {
  --bg: #ffffff;

  --panel-blue: #dff1ff;      /* links */
  --panel-lila: #f0e4ff;      /* mitte */
  --panel-tuerkis: #d6faff;   /* rechts */
  --panel-peach: #ffe7cf;

  --text: #262335;
  --text-light: #6b647a;
  --border: #e1d7f0;
  --shadow: rgba(15, 23, 42, 0.08);

  --primary: #ff7be0;
  --primary-dark: #e24ec0;

  --blue: #60a5fa;
  --yellow: #facc15;
  --red: #f97373;
  --green: #22c55e;

  --rainbow: linear-gradient(
    90deg,
    #ff9f4a,
    #ff6fae,
    #b86dff,
    #6bb7ff,
    #00bcd4
  );
}

/* DARK MODE */
body.dark {
  --bg: #0f172a;

  --panel-blue: #1e293b;
  --panel-lila: #312e81;
  --panel-tuerkis: #083344;
  --panel-peach: #1f2937;

  --text: #e5e7eb;
  --text-light: #9ca3af;
  --border: #374151;
  --shadow: rgba(0,0,0,0.7);

  --primary: #fb7bbf;
  --primary-dark: #f472b6;
}

/* ---------------------------------------------------------
   GLOBAL
--------------------------------------------------------- */
body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: "Segoe UI", sans-serif;
}

.app {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

/* ---------------------------------------------------------
   HEADER
--------------------------------------------------------- */
.app-header {
  background: linear-gradient(90deg,
    rgba(255,159,74,0.12),
    rgba(255,111,174,0.12),
    rgba(184,109,255,0.12),
    rgba(107,183,255,0.12),
    rgba(0,188,212,0.12)
  );
  border-radius: 20px;
  padding: 18px;
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
}

.title-block h1 {
  margin: 0;
  font-size: 2.6rem;
  background: var(--rainbow);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  font-weight: 900;
}

.title-block p {
  margin: 4px 0 0;
  color: var(--text-light);
}

.header-right {
  text-align: right;
}

.status-legend span {
  margin-left: 10px;
  font-size: 0.85rem;
  color: var(--text-light);
}

.dot {
  width: 10px; height: 10px;
  border-radius: 50%; display: inline-block;
  margin-right: 4px;
}
.dot-open { background: var(--blue); }
.dot-skonto { background: var(--yellow); }
.dot-overdue { background: var(--red); }
.dot-paid { background: var(--green); }

.theme-toggle {
  margin-top: 10px;
  background: #ffffffaa;
  padding: 7px 12px;
  border-radius: 12px;
  border: 1px solid var(--border);
  cursor: pointer;
  font-size: 1.2rem;
}

/* ---------------------------------------------------------
   LAYOUT
--------------------------------------------------------- */
.layout {
  display: grid;
  grid-template-columns: 1.2fr 2fr 1.2fr;
  gap: 20px;
}

/* Panels */
.panel {
  padding: 20px;
  border-radius: 18px;
  border: 1px solid var(--border);
  box-shadow: 0 10px 20px var(--shadow);
}

.panel-form { background: var(--panel-blue); }
.panel-list { background: var(--panel-lila); }
.panel-suppliers { background: var(--panel-tuerkis); }

/* ---------------------------------------------------------
   FORMULAR
--------------------------------------------------------- */
.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 15px;
}

.form-field label {
  margin-bottom: 6px;
  font-weight: 600;
  white-space: nowrap;
}

.form-field input,
.form-field select {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #fff;
  font-size: 1rem;
  height: 45px;
}

.form-field textarea {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #fff;
  font-size: 1rem;
  min-height: 70px;
}

.form-field-wide {
  grid-column: span 2;
}

.form-actions {
  margin-top: 18px;
  display: flex;
  gap: 12px;
}

.req { color: var(--red); }

/* ---------------------------------------------------------
   BUTTONS
--------------------------------------------------------- */
.btn {
  padding: 10px 18px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
}
.btn.primary { background: var(--primary); color: #fff; }
.btn.primary:hover { background: var(--primary-dark); }
.btn.ghost { border: 1px solid var(--primary); background: transparent; color: var(--primary); }
.btn.ghost:hover { background: var(--primary); color: #fff; }

/* ---------------------------------------------------------
   TABELLE
--------------------------------------------------------- */
.table-wrapper {
  background: #ffffffaa;
  padding: 10px;
  border-radius: 12px;
  border: 1px solid var(--border);
}

.invoice-table {
  width: 100%;
  border-collapse: collapse;
}

.invoice-table th,
.invoice-table td {
  padding: 10px;
  border-bottom: 1px solid var(--border);
}

.numeric { text-align: right; }

.row-open { background: #eaf5ff; }
.row-skonto { background: #fff4c2; }
.row-overdue { background: #ffd6d6; }
.row-paid { background: #d9ffe3; }

/* ---------------------------------------------------------
   SUPPLIER CARDS
--------------------------------------------------------- */
.supplier-card {
  background: #ffffffbb;
  border: 1px solid var(--border);
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 10px;
  cursor: pointer;
}
.supplier-card:hover {
  background: #fff;
}
.chip {
  margin-right: 6px;
  font-size: 0.9rem;
  padding: 6px 12px;
  border-radius: 999px;
  border: 1px solid transparent;
  background: #ffffffaa;
}
.chip.active {
  background: var(--primary);
  color: #fff;
}
.supplier-card.active {
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(0,0,0,0.05);
}

/* ---------------------------------------------------------
   EMPTY STATE
--------------------------------------------------------- */
.empty-state {
  text-align: center;
  color: var(--text-light);
  padding: 20px;
}
   /* Highlight im Darkmode */
.dark #paymentPopup > div {
  background: #1e293b;
  color: white;
}

/* ==========================================================
   DARK MODE FIX ‚Äì bessere Lesbarkeit
========================================================== */

.dark body,
.dark {
    color: #111 !important;
}

.dark .panel, 
.dark .panel-form,
.dark .panel-list,
.dark .panel-suppliers {
    background: rgba(255,255,255,0.08) !important;
    color: #111 !important;
}

.dark input,
.dark select,
.dark textarea {
    background-color: #ffffff !important;
    color: #000 !important;
    border: 1px solid #444 !important;
}

.dark table tbody tr {
    background-color: rgba(255,255,255,0.85) !important;
    color: #000 !important;
}

.dark table thead tr {
    background-color: rgba(255,255,255,0.2) !important;
    color: #000 !important;
}

.dark button,
.dark .chip {
    background-color: #fff !important;
    color: #000 !important;
    border: 1px solid #444 !important;
}

.dark i, 
.dark .icon {
    color: #000 !important;
}   
</style>
</head>

<body>
<div class="app">
<!-- ============================================
         POPUP: TEILZAHLUNGEN
    ============================================ -->
    <div id="paymentPopup" style="position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:9999;">
      <div style="background:white; padding:25px; border-radius:15px; width:400px; max-height:80vh; overflow:auto; box-shadow:0 10px 40px rgba(0,0,0,0.2);">
        <h2>Teilzahlungen</h2>
        <div id="paymentList" style="margin-bottom:20px;"></div>

        <h3>Neue Teilzahlung hinzuf√ºgen</h3>
        <label>Datum:</label>
        <input type="date" id="payDate" style="width:100%;margin-bottom:10px;">
        <label>Betrag (‚Ç¨):</label>
        <input type="number" id="payAmount" style="width:100%;margin-bottom:10px;">
        <label>Notiz:</label>
        <input type="text" id="payNote" style="width:100%;margin-bottom:10px;">

        <button id="addPaymentBtn" class="btn primary" style="width:100%;margin-bottom:10px;">Teilzahlung speichern</button>
        <button id="closePaymentPopup" class="btn ghost" style="width:100%;">Schlie√üen</button>
      </div>
    </div>
<!-- HEADER -->
<header class="app-header">
  <div class="title-block">
    <h1>Rechnungs-Cockpit</h1>
    <p>Alles im Blick ‚Äì Skonto, F√§lligkeiten, Lieferanten üíñ</p>
  </div>

  <div class="header-right">
    <div class="status-legend">
      <span><span class="dot dot-open"></span>offen</span>
      <span><span class="dot dot-skonto"></span>Skonto</span>
      <span><span class="dot dot-overdue"></span>√ºberf√§llig</span>
      <span><span class="dot dot-paid"></span>bezahlt</span>
    </div>
    <button id="themeToggle" class="theme-toggle">üåû</button>
  </div>
</header>

<!-- LAYOUT -->
<div class="layout">

<!-- FORM -->
<section class="panel panel-form">
  <h2>Neue Rechnung erfassen</h2>

  <form id="invoiceForm">
    <div class="form-grid">

      <div class="form-field">
        <label>Rechnungsnummer <span class="req">*</span></label>
        <input id="invoiceNumber" required>
      </div>

      <div class="form-field">
        <label>Lieferant <span class="req">*</span></label>
        <input id="supplier" required list="supplierList">
        <datalist id="supplierList"></datalist>
      </div>

      <div class="form-field">
        <label>Betrag (‚Ç¨) <span class="req">*</span></label>
        <input id="amount" type="number" step="0.01" required>
      </div>

      <div class="form-field">
        <label>F√§lligkeitsdatum <span class="req">*</span></label>
        <input id="dueDate" type="date" required>
      </div>

      <div class="form-field">
        <label>Skonto (%)</label>
        <select id="skontoPercent">
          <option value="">‚Äì</option>
          <option value="2">2%</option>
          <option value="3">3%</option>
          <option value="5">5%</option>
        </select>
      </div>

      <div class="form-field">
        <label>Skonto bis</label>
        <input id="skontoDate" type="date">
      </div>

      <div class="form-field form-field-wide">
        <label>Notiz</label>
        <textarea id="note"></textarea>
      </div>

    </div>

    <div class="form-actions">
      <button class="btn primary" type="submit" id="saveButton">Rechnung speichern</button>
      <button class="btn ghost" type="button" id="clearForm">Felder leeren</button>
    </div>
  </form>
</section>

<!-- LIST -->
<section class="panel panel-list">
  <h2>Offene Rechnungen</h2>

  <div class="toolbar">
    <button class="btn chip" data-status="all">Alle</button>
    <button class="btn chip active" data-status="open">Offen</button>
    <button class="btn chip" data-status="skonto">Skonto</button>
    <button class="btn chip" data-status="overdue">√úberf√§llig</button>
    <button class="btn chip" data-status="paid">Bezahlt</button>

    <input placeholder="Suchen..." id="search">
  </div>

  <div class="table-wrapper">
    <table class="invoice-table">
      <thead>
        <tr>
          <th>Status</th>
          <th>Re-Nr.</th>
          <th>Lieferant</th>
          <th class="numeric">Betrag</th>
          <th class="numeric">Sk %</th>
          <th class="numeric">Sk ‚Ç¨</th>
          <th>Sk. bis</th>
          <th>F√§lligkeit</th>
          <th>Warnung</th>
          <th>Bez.</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody id="invoiceTableBody">
        <tr><td colspan="11" class="empty-state">Noch nichts erfasst üíñ</td></tr>
      </tbody>
    </table>
  </div>
</section>

<!-- SUPPLIERS -->
<section class="panel panel-suppliers">
  <h2>Lieferanten</h2>
  <div id="supplierCards"></div>

  <div class="summary-box">
    <strong>Summen</strong><br>
    Offen: <span id="sumOpen">0 ‚Ç¨</span><br>
    √úberf√§llig: <span id="sumOverdue">0 ‚Ç¨</span><br>
    Skonto: <span id="sumSkonto">0 ‚Ç¨</span>
  </div>
</section>

</div><!-- layout -->

</div><!-- app -->

<script>
/* =====================================================
   STORAGE
===================================================== */
function loadInvoices() {
  return JSON.parse(localStorage.getItem("cockpitInvoices") || "[]");
}
function saveInvoices(list) {
  localStorage.setItem("cockpitInvoices", JSON.stringify(list));
}

/* =====================================================
   DOM ELEMENTS & STATE
===================================================== */
const form = document.getElementById("invoiceForm");
const tableBody = document.getElementById("invoiceTableBody");
const supplierCards = document.getElementById("supplierCards");
const search = document.getElementById("search");

const sumOpen = document.getElementById("sumOpen");
const sumOverdue = document.getElementById("sumOverdue");
const sumSkonto = document.getElementById("sumSkonto");

const themeToggle = document.getElementById("themeToggle");
const clearFormBtn = document.getElementById("clearForm");
const saveButton = document.getElementById("saveButton");
const supplierList = document.getElementById("supplierList");
const statusChips = document.querySelectorAll(".chip");

let currentStatusFilter = "all";
let supplierFilter = null;
let editId = null;

/* =====================================================
   THEME TOGGLE
===================================================== */
themeToggle.addEventListener("click", () => {
  document.body.classList.toggle("dark");
  themeToggle.textContent =
    document.body.classList.contains("dark") ? "üåô" : "üåû";
});

/* =====================================================
   FORM SUBMIT (CREATE / UPDATE)
===================================================== */
form.addEventListener("submit", (e) => {
  e.preventDefault();

  const base = {
    number: document.getElementById("invoiceNumber").value.trim(),
    supplier: document.getElementById("supplier").value.trim().toUpperCase(),
    amount: parseFloat(document.getElementById("amount").value),
    dueDate: document.getElementById("dueDate").value,
    skontoPercent: document.getElementById("skontoPercent").value,
    skontoDate: document.getElementById("skontoDate").value,
    note: document.getElementById("note").value
  };

  if (!base.number || !base.supplier || !base.dueDate || isNaN(base.amount)) {
    alert("Bitte Rechnungsnummer, Lieferant, Betrag und F√§lligkeitsdatum ausf√ºllen.");
    return;
  }

  const list = loadInvoices();

  if (editId !== null) {
    const idx = list.findIndex(i => i.id === editId);
    if (idx !== -1) {
      list[idx] = Object.assign({}, list[idx], base);
    }
  } else {
    const inv = Object.assign({
      id: Date.now(),
      paid: false
    }, base);
    list.push(inv);
  }

  saveInvoices(list);
  editId = null;
  saveButton.textContent = "Rechnung speichern";
  form.reset();
  updateUI();
});

/* =====================================================
   CLEAR FORM
===================================================== */
clearFormBtn.addEventListener("click", () => {
  editId = null;
  saveButton.textContent = "Rechnung speichern";
  form.reset();
});

/* =====================================================
   STATUS & FILTER HELFER
===================================================== */
function getStatus(inv) {
  const today = new Date();
  const due = inv.dueDate ? new Date(inv.dueDate) : null;
  const sk = inv.skontoDate ? new Date(inv.skontoDate) : null;

  if (inv.paid) return "paid";
  if (due && due < today) return "overdue";
  if (sk && sk >= today) return "skonto";
  return "open";
}

function getFilteredList(list) {
  let filtered = list.slice();

  if (currentStatusFilter !== "all") {
    filtered = filtered.filter(inv => getStatus(inv) === currentStatusFilter);
  }

  if (supplierFilter) {
    filtered = filtered.filter(inv => inv.supplier === supplierFilter);
  }

  const q = search.value.trim().toLowerCase();
  if (q) {
    filtered = filtered.filter(inv =>
      inv.number.toLowerCase().includes(q) ||
      inv.supplier.toLowerCase().includes(q) ||
      (inv.note || "").toLowerCase().includes(q)
    );
  }

  return filtered;
}

/* =====================================================
   STATUS CHIP EVENTS
===================================================== */
statusChips.forEach(chip => {
  chip.addEventListener("click", () => {
    statusChips.forEach(c => c.classList.remove("active"));
    chip.classList.add("active");
    currentStatusFilter = chip.dataset.status || "all";
    updateUI();
  });
});

/* =====================================================
   TABLE RENDERING
===================================================== */
function updateUI() {
  const list = loadInvoices();

  renderSuppliers(list);
  renderSupplierDatalist(list);
  renderSupplierTotals(list);

  if (list.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="11" class="empty-state">Noch keine Rechnungen üíñ</td></tr>';
    return;
  }

  const filtered = getFilteredList(list);
  renderTable(filtered, list.length);
}

function renderTable(list, totalCount) {
  if (list.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="11" class="empty-state">Keine Rechnungen f√ºr den aktuellen Filter üßê</td></tr>';
    return;
  }

  let rows = "";

  list.forEach(inv => {
    const status = getStatus(inv);

    let rowClass = "row-open";
    let warn = "";

    if (status === "paid") {
      rowClass = "row-paid";
    } else if (status === "overdue") {
      rowClass = "row-overdue";
      warn = "‚ùó";
    } else if (status === "skonto") {
      rowClass = "row-skonto";
    }

    const skAmount = inv.skontoPercent
      ? (inv.amount * (inv.skontoPercent / 100)).toFixed(2)
      : "-";

    const dot =
      status === "paid" ? "‚úî" :
      status === "overdue" ? "‚ùó" :
      status === "skonto" ? "üíõ" :
      "üîµ";

    rows += `
      <tr class="${rowClass}">
        <td>${dot}</td>
        <td>${inv.number}</td>
        <td>${inv.supplier}</td>
        <td class="numeric">${inv.amount.toFixed(2)}</td>
        <td class="numeric">${inv.skontoPercent || "-"}</td>
        <td class="numeric">${skAmount}</td>
        <td>${inv.skontoDate || "-"}</td>
        <td>${inv.dueDate}</td>
        <td>${warn}</td>
        <td>
          <input type="checkbox" data-id="${inv.id}" class="paidCheck" ${inv.paid ? "checked" : ""}>
        </td>
        <td>
  <button class="editBtn" data-id="${inv.id}">‚úèÔ∏è</button>
  <button class="payBtn" data-id="${inv.id}">üí∂</button>
  <button class="deleteBtn" data-id="${inv.id}">‚ùå</button>
</td>
      </tr>
    `;
  });

  tableBody.innerHTML = rows;
  attachRowEvents();
}

/* =====================================================
   ROW EVENTS (PAID / EDIT / DELETE)
===================================================== */
function attachRowEvents() {
  document.querySelectorAll(".paidCheck").forEach(cb => {
    cb.addEventListener("change", () => {
      const id = Number(cb.dataset.id);
      const list = loadInvoices();
      const inv = list.find(a => a.id === id);
      if (!inv) return;
      inv.paid = cb.checked;
      saveInvoices(list);
      updateUI();
    });
  });

  document.querySelectorAll(".deleteBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      if (!confirm("Rechnung wirklich l√∂schen?")) return;
      const id = Number(btn.dataset.id);
      let list = loadInvoices();
      list = list.filter(a => a.id !== id);
      saveInvoices(list);
      updateUI();
    });
  });

  document.querySelectorAll(".editBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = Number(btn.dataset.id);
      const list = loadInvoices();
      const inv = list.find(a => a.id === id);
      if (!inv) return;

      editId = id;
      document.getElementById("invoiceNumber").value = inv.number;
      document.getElementById("supplier").value = inv.supplier;
      document.getElementById("amount").value = inv.amount;
      document.getElementById("dueDate").value = inv.dueDate;
      document.getElementById("skontoPercent").value = inv.skontoPercent || "";
      document.getElementById("skontoDate").value = inv.skontoDate || "";
      document.getElementById("note").value = inv.note || "";

      saveButton.textContent = "Rechnung aktualisieren";
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  });
}

/* =====================================================
   SUPPLIERS PANEL
===================================================== */
function renderSuppliers(list) {
  const suppliers = [...new Set(list.map(a => a.supplier))];

  if (suppliers.length === 0) {
    supplierCards.innerHTML = "";
    return;
  }

  supplierCards.innerHTML = suppliers.map(s => `
    <div class="supplier-card ${supplierFilter === s ? "active" : ""}" data-supplier="${s}">${s}</div>
  `).join("");

  document.querySelectorAll(".supplier-card").forEach(card => {
    card.addEventListener("click", () => {
      const s = card.dataset.supplier;
      supplierFilter = supplierFilter === s ? null : s;
      updateUI();
    });
  });
}
/* =====================================================
   LIEFERANTENSUMMEN ‚Äì NUR F√úR GEW√ÑHLTEN LIEFERANTEN
===================================================== */
function renderSupplierTotals(list) {
  const box = document.querySelector(".summary-box");

  if (!supplierFilter) {
    // Normale Gesamtwerte anzeigen
    renderSummary(list);
    return;
  }

  const filtered = list.filter(inv => inv.supplier === supplierFilter);
  const now = new Date();

  let open = 0, overdue = 0, skonto = 0;

  filtered.forEach(inv => {
    if (!inv.paid) open += inv.amount;
    if (!inv.paid && inv.dueDate && new Date(inv.dueDate) < now)
      overdue += inv.amount;
    if (!inv.paid && inv.skontoDate && new Date(inv.skontoDate) >= now)
      skonto += inv.amount;
  });

  document.getElementById("sumOpen").textContent = open.toFixed(2) + " ‚Ç¨";
  document.getElementById("sumOverdue").textContent = overdue.toFixed(2) + " ‚Ç¨";
  document.getElementById("sumSkonto").textContent = skonto.toFixed(2) + " ‚Ç¨";
}

function renderSupplierDatalist(list) {
  const suppliers = [...new Set(list.map(a => a.supplier))];
  supplierList.innerHTML = suppliers.map(s => `<option value="${s}"></option>`).join("");
}

/* =====================================================
   SUMMARIES
===================================================== */
function renderSummary(list) {
  let open = 0, overdue = 0, skonto = 0;
  const now = new Date();

  list.forEach(inv => {
    if (!inv.paid) open += inv.amount;

    if (!inv.paid && inv.dueDate && new Date(inv.dueDate) < now)
      overdue += inv.amount;

    if (!inv.paid && inv.skontoDate && new Date(inv.skontoDate) >= now)
      skonto += inv.amount;
  });

  sumOpen.textContent = open.toFixed(2) + " ‚Ç¨";
  sumOverdue.textContent = overdue.toFixed(2) + " ‚Ç¨";
  sumSkonto.textContent = skonto.toFixed(2) + " ‚Ç¨";
}

/* =====================================================
   INIT
===================================================== */
search.addEventListener("input", () => updateUI());
/* =====================================================
   POPUP BEIM LADEN WENN √úBERF√ÑLLIGE RECHNUNGEN EXISTIEREN
===================================================== */
window.addEventListener("load", () => {
  const list = loadInvoices();
  const now = new Date();

  const hasOverdue = list.some(inv =>
    !inv.paid &&
    inv.dueDate &&
    new Date(inv.dueDate) < now
  );

  if (hasOverdue) {
    alert("‚ö†Ô∏è Achtung!\nEs gibt √ºberf√§llige Rechnungen!");
  }
});
/* =====================================================
   TEILZAHLUNGEN ‚Äì LOGIK
===================================================== */
let currentPaymentInvoice = null;

function openPaymentPopup(invoiceId) {
  currentPaymentInvoice = invoiceId;
  const list = loadInvoices();
  const inv = list.find(x => x.id === invoiceId);

  if (!inv.payments) inv.payments = [];

  // Liste der bestehenden Teilzahlungen
  let html = "";
  if (inv.payments.length === 0) {
    html = "<p>Noch keine Teilzahlungen.</p>";
  } else {
    html = inv.payments.map(p => `
      <div style="padding:8px;border:1px solid #ccc;border-radius:8px;margin-bottom:8px;">
        <strong>${p.date}</strong> ‚Äì ${p.amount.toFixed(2)} ‚Ç¨
        <br><small>${p.note || ""}</small>
      </div>
    `).join("");
  }

  document.getElementById("paymentList").innerHTML = html;

  document.getElementById("paymentPopup").style.display = "flex";
}

document.getElementById("closePaymentPopup").addEventListener("click", () => {
  document.getElementById("paymentPopup").style.display = "none";
});

document.getElementById("addPaymentBtn").addEventListener("click", () => {
  const date = document.getElementById("payDate").value;
  const amount = parseFloat(document.getElementById("payAmount").value);
  const note = document.getElementById("payNote").value;

  if (!date || isNaN(amount) || amount <= 0) {
    alert("Bitte Datum und Betrag eingeben.");
    return;
  }

  const list = loadInvoices();
  const inv = list.find(x => x.id === currentPaymentInvoice);

  if (!inv.payments) inv.payments = [];

  inv.payments.push({
    date,
    amount,
    note
  });

  // Restbetrag pr√ºfen
  const paidSum = inv.payments.reduce((a,b) => a + b.amount, 0);
  if (paidSum >= inv.amount) inv.paid = true;

  saveInvoices(list);
  updateUI();
  openPaymentPopup(currentPaymentInvoice);
});

updateUI();

</script>

</body>
</html>
