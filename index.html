<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Rechnungs-Cockpit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #f3f0ff;
      --bg-gradient: linear-gradient(135deg, #fdf2ff, #e0f2ff);
      --primary: #ec4899;
      --primary-dark: #db2777;
      --accent-blue: #3b82f6;
      --accent-violet: #8b5cf6;
      --accent-teal: #14b8a6;
      --border: #e2e8f0;
      --text-main: #0f172a;
      --text-light: #64748b;
      --red: #ef4444;
      --orange: #f97316;
      --green: #16a34a;
      --credit-green: #4ade80;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg-gradient);
      color: var(--text-main);
    }

    .app {
      min-height: 100vh;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* HEADER */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .title-block h1 {
      margin: 0;
      font-size: 2rem;
      background: linear-gradient(90deg, #ec4899, #8b5cf6, #22c55e);
      -webkit-background-clip: text;
      color: transparent;
    }
    .title-block p {
      margin: 4px 0 0;
      color: var(--text-light);
      font-size: 0.95rem;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--text-light);
    }
    .status-legend span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
    }
    .dot-open { background: #3b82f6; }
    .dot-skonto { background: #facc15; }
    .dot-overdue { background: #ef4444; }
    .dot-paid { background: #22c55e; }

    .theme-toggle {
      border-radius: 999px;
      border: none;
      background: #fff;
      padding: 8px 12px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.12);
      font-size: 1.1rem;
    }

    /* LAYOUT */
    .layout {
      display: grid;
      grid-template-columns: 2fr 3fr 1.5fr;
      gap: 16px;
      align-items: flex-start;
    }

    .panel {
      background: #ffffffbb;
      border-radius: 16px;
      padding: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      backdrop-filter: blur(10px);
    }

    .panel h2 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    /* FORM */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 12px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .form-field label {
      font-size: 0.9rem;
      color: var(--text-light);
    }

    .form-field input,
    .form-field select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 0.95rem;
      height: 42px;
    }

    .form-field textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 0.95rem;
      min-height: 60px;
      resize: vertical;
    }

    .form-field-wide {
      grid-column: span 2;
    }

    .form-actions {
      margin-top: 12px;
      display: flex;
      gap: 10px;
    }

    .req {
      color: var(--red);
    }

    /* BUTTONS */
    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .btn.primary {
      background: var(--primary);
      color: #fff;
    }
    .btn.primary:hover {
      background: var(--primary-dark);
    }
    .btn.ghost {
      border: 1px solid var(--primary);
      background: transparent;
      color: var(--primary);
    }
    .btn.ghost:hover {
      background: var(--primary);
      color: #fff;
    }

    .btn.small {
      padding: 4px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
    }

    /* LIST / TABLE */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .chip {
      margin-right: 2px;
      font-size: 0.8rem;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: #ffffffaa;
    }
    .chip.active {
      background: var(--primary);
      color: #fff;
    }

    #search {
      margin-left: auto;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      min-width: 150px;
      font-size: 0.85rem;
    }

    .table-wrapper {
      background: #ffffffaa;
      padding: 8px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .invoice-table th,
    .invoice-table td {
      padding: 8px;
      border-bottom: 1px solid var(--border);
    }

    .invoice-table th {
      text-align: left;
      font-weight: 600;
      color: var(--text-light);
    }

    .numeric {
      text-align: right;
    }

    .rest-cell {
      font-weight: 700;
    }

    .row-open { background: #eaf5ff; }
    .row-skonto { background: #fff4c2; }
    .row-overdue { background: #ffd6d6; }
    .row-paid { background: #d9ffe3; }
    .row-ob { box-shadow: inset 0 0 0 2px rgba(249,115,22,0.4); }
    .row-credit {
      box-shadow: 0 0 0 2px rgba(74,222,128,0.7);
    }

    .empty-state {
      text-align: center;
      color: var(--text-light);
      padding: 18px;
    }

    /* SUPPLIER PANEL */
    .supplier-card {
      background: #ffffffbb;
      border: 1px solid var(--border);
      padding: 10px;
      border-radius: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .supplier-card:hover {
      background: #fff;
    }
    .supplier-card.active {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(236,72,153,0.15);
    }

    .summary-box {
      margin-top: 12px;
      padding: 10px;
      border-radius: 12px;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 0.85rem;
    }
    .summary-box strong {
      font-size: 0.9rem;
    }

    /* Darkmode Fix inkl. Payment-/Credit-Popup */
    .dark body,
    .dark {
      color: #111 !important;
    }

    .dark .panel,
    .dark .panel-form,
    .dark .panel-list,
    .dark .panel-suppliers {
      background: rgba(255,255,255,0.08) !important;
      color: #111 !important;
    }

    .dark input,
    .dark select,
    .dark textarea {
      background-color: #ffffff !important;
      color: #000 !important;
      border: 1px solid #444 !important;
    }

    .dark table tbody tr {
      background-color: rgba(255,255,255,0.85) !important;
      color: #000 !important;
    }

    .dark table thead tr {
      background-color: rgba(255,255,255,0.2) !important;
      color: #000 !important;
    }

    .dark button,
    .dark .chip {
      background-color: #fff !important;
      color: #000 !important;
      border: 1px solid #444 !important;
    }

    .dark i,
    .dark .icon {
      color: #000 !important;
    }

    .dark #paymentPopup > div,
    .dark #creditPopup > div {
      background: #1e293b;
      color: white;
    }

    /* OB-Button */
    .obBtn.active {
      background: var(--orange);
      color: #fff;
    }

    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
<div class="app">

  <!-- POPUP: TEILZAHLUNGEN -->
  <div id="paymentPopup" style="position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:9999;">
    <div style="background:white; padding:25px; border-radius:15px; width:400px; max-height:80vh; overflow:auto; box-shadow:0 10px 40px rgba(0,0,0,0.2);">
      <h2>Teilzahlungen</h2>
      <div id="paymentList" style="margin-bottom:20px;"></div>

      <h3>Neue Teilzahlung hinzuf√ºgen</h3>
      <label>Datum:</label>
      <input type="date" id="payDate" style="width:100%;margin-bottom:10px;">
      <label>Betrag (‚Ç¨):</label>
      <input type="number" id="payAmount" style="width:100%;margin-bottom:10px;">
      <label>Notiz:</label>
      <input type="text" id="payNote" style="width:100%;margin-bottom:10px;">

      <button id="addPaymentBtn" class="btn primary" style="width:100%;margin-bottom:10px;">Teilzahlung speichern</button>
      <button id="closePaymentPopup" class="btn ghost" style="width:100%;">Schlie√üen</button>
    </div>
  </div>

  <!-- POPUP: GUTSCHRIFTEN -->
  <div id="creditPopup" style="position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:9999;">
    <div style="background:white; padding:25px; border-radius:15px; width:400px; max-height:80vh; overflow:auto; box-shadow:0 10px 40px rgba(0,0,0,0.2);">
      <h2>Gutschriften</h2>
      <div id="creditList" style="margin-bottom:20px;"></div>

      <h3>Neue Gutschrift hinzuf√ºgen</h3>
      <label>Datum:</label>
      <input type="date" id="creditDate" style="width:100%;margin-bottom:10px;">
      <label>Betrag (‚Ç¨):</label>
      <input type="number" id="creditAmount" style="width:100%;margin-bottom:10px;">
      <label>Notiz:</label>
      <input type="text" id="creditNote" style="width:100%;margin-bottom:10px;">

      <button id="addCreditBtn" class="btn primary" style="width:100%;margin-bottom:10px;">Gutschrift speichern</button>
      <button id="closeCreditPopup" class="btn ghost" style="width:100%;">Schlie√üen</button>
    </div>
  </div>

  <!-- HEADER -->
  <header class="app-header">
    <div class="title-block">
      <h1>Rechnungs-Cockpit</h1>
      <p>Alles im Blick ‚Äì Skonto, F√§lligkeiten, Teilzahlungen, Gutschriften & Lieferanten üíñ</p>
    </div>

    <div class="header-right">
      <div class="status-legend">
        <span><span class="dot dot-open"></span>offen</span>
        <span><span class="dot dot-skonto"></span>Skonto</span>
        <span><span class="dot dot-overdue"></span>√ºberf√§llig</span>
        <span><span class="dot dot-paid"></span>bezahlt</span>
      </div>
      <button id="themeToggle" class="theme-toggle">üåû</button>
    </div>
  </header>

  <!-- LAYOUT -->
  <div class="layout">
    <!-- FORM -->
    <section class="panel panel-form">
      <h2>Rechnung erfassen / bearbeiten</h2>
      <form id="invoiceForm">
        <div class="form-grid">
          <div class="form-field">
            <label>Re-Nr. <span class="req">*</span></label>
            <input id="invoiceNumber" type="text" />
          </div>

          <div class="form-field">
            <label>Lieferant <span class="req">*</span></label>
            <input id="supplier" type="text" list="supplierList" />
            <datalist id="supplierList"></datalist>
          </div>

          <div class="form-field">
            <label>Betrag (‚Ç¨) <span class="req">*</span></label>
            <input id="amount" type="number" step="0.01" />
          </div>

          <div class="form-field">
            <label>F√§llig am <span class="req">*</span></label>
            <input id="dueDate" type="date" />
          </div>

          <div class="form-field">
            <label>Skonto (%)</label>
            <select id="skontoPercent">
              <option value="">‚Äì</option>
              <option value="2">2%</option>
              <option value="3">3%</option>
              <option value="5">5%</option>
            </select>
          </div>

          <div class="form-field">
            <label>Skonto bis</label>
            <input id="skontoDate" type="date" />
          </div>

          <div class="form-field form-field-wide">
            <label>Notiz</label>
            <textarea id="note"></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button class="btn primary" type="submit" id="saveButton">Rechnung speichern</button>
          <button class="btn ghost" type="button" id="clearForm">Felder leeren</button>
        </div>
      </form>
    </section>

    <!-- LISTE -->
    <section class="panel panel-list">
      <h2>Rechnungen</h2>

      <div class="toolbar">
        <button class="btn chip" data-status="all">Alle</button>
        <button class="btn chip active" data-status="open">Offen</button>
        <button class="btn chip" data-status="skonto">Skonto</button>
        <button class="btn chip" data-status="overdue">√úberf√§llig</button>
        <button class="btn chip" data-status="paid">Bezahlt</button>

        <input placeholder="Suchen..." id="search" />
      </div>
<div style="margin-top:10px; display:flex; gap:10px;">
    <button class="btn ghost" id="exportData">Backup exportieren</button>
    <button class="btn ghost" id="importData">Backup importieren</button>
    <input type="file" id="importFile" style="display:none" accept=".json" />
</div>

      <div class="table-wrapper">
        <table class="invoice-table">
          <thead>
            <tr>
              <th>Status</th>
              <th>Re-Nr.</th>
              <th>Lieferant</th>
              <th class="numeric">Betrag</th>
              <th class="numeric">GS (‚Ç¨)</th>
              <th class="numeric">Rest (‚Ç¨)</th>
              <th class="numeric">Sk %</th>
              <th class="numeric">Sk ‚Ç¨</th>
              <th>Sk. bis</th>
              <th>F√§lligkeit</th>
              <th>Warnung</th>
              <th>Bez.</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody id="invoiceTableBody">
            <tr><td colspan="13" class="empty-state">Noch keine Rechnungen üíñ</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- LIEFERANTEN -->
    <section class="panel panel-suppliers">
      <h2>Lieferanten</h2>
      <div id="supplierCards"></div>

      <div class="summary-box">
        <strong>Summen</strong><br />
        Offen: <span id="sumOpen">0 ‚Ç¨</span><br />
        √úberf√§llig: <span id="sumOverdue">0 ‚Ç¨</span><br />
        Skonto: <span id="sumSkonto">0 ‚Ç¨</span>
      </div>
    </section>

  </div><!-- layout -->

</div><!-- app -->

<script>
/* =====================================================
   STORAGE
===================================================== */
function loadInvoices() {
  const raw = localStorage.getItem("cockpitInvoices") || "[]";
  let list = JSON.parse(raw);
  // Defaults f√ºr alte Eintr√§ge
  list.forEach(inv => {
    if (inv.inOB === undefined) inv.inOB = false;
    if (!inv.payments) inv.payments = [];
    if (!inv.credits) inv.credits = [];
  });
  return list;
}
function saveInvoices(list) {
  localStorage.setItem("cockpitInvoices", JSON.stringify(list));
}

/* =====================================================
   DOM ELEMENTS & STATE
===================================================== */
const form = document.getElementById("invoiceForm");
const tableBody = document.getElementById("invoiceTableBody");
const supplierCards = document.getElementById("supplierCards");
const search = document.getElementById("search");

const sumOpen = document.getElementById("sumOpen");
const sumOverdue = document.getElementById("sumOverdue");
const sumSkonto = document.getElementById("sumSkonto");

const themeToggle = document.getElementById("themeToggle");
const clearFormBtn = document.getElementById("clearForm");
const saveButton = document.getElementById("saveButton");
const supplierList = document.getElementById("supplierList");
const statusChips = document.querySelectorAll(".chip");

let currentStatusFilter = "all";
let supplierFilter = null;
let editId = null;

let currentPaymentInvoice = null;
let currentCreditInvoice = null;

/* =====================================================
   THEME TOGGLE
===================================================== */
themeToggle.addEventListener("click", () => {
  document.body.classList.toggle("dark");
  themeToggle.textContent =
    document.body.classList.contains("dark") ? "üåô" : "üåû";
});

/* =====================================================
   HELFER: TOTALS
===================================================== */
function computeTotals(inv) {
  const amount = inv.amount || 0;
  const creditTotal = (inv.credits || []).reduce((a, c) => a + (c.amount || 0), 0);
  const paymentTotal = (inv.payments || []).reduce((a, p) => a + (p.amount || 0), 0);
  const rest = amount - creditTotal - paymentTotal;
  return { amount, creditTotal, paymentTotal, rest };
}

/* =====================================================
   FORM SUBMIT (CREATE / UPDATE)
===================================================== */
form.addEventListener("submit", (e) => {
  e.preventDefault();

  const base = {
    number: document.getElementById("invoiceNumber").value.trim(),
    supplier: document.getElementById("supplier").value.trim().toUpperCase(),
    amount: parseFloat(document.getElementById("amount").value),
    dueDate: document.getElementById("dueDate").value,
    skontoPercent: document.getElementById("skontoPercent").value,
    skontoDate: document.getElementById("skontoDate").value,
    note: document.getElementById("note").value
  };

  if (!base.number || !base.supplier || !base.dueDate || isNaN(base.amount)) {
    alert("Bitte Rechnungsnummer, Lieferant, Betrag und F√§lligkeitsdatum ausf√ºllen.");
    return;
  }

  const list = loadInvoices();

  if (editId !== null) {
    const idx = list.findIndex(i => i.id === editId);
    if (idx !== -1) {
      list[idx] = Object.assign({}, list[idx], base);
    }
  } else {
    const inv = Object.assign({
      id: Date.now(),
      paid: false,
      inOB: false,
      payments: [],
      credits: []
    }, base);
    list.push(inv);
  }

  saveInvoices(list);
  editId = null;
  saveButton.textContent = "Rechnung speichern";
  form.reset();
  updateUI();
});

/* CLEAR FORM */
clearFormBtn.addEventListener("click", () => {
  editId = null;
  saveButton.textContent = "Rechnung speichern";
  form.reset();
});

/* =====================================================
   STATUS & FILTER
===================================================== */
function getStatus(inv) {
  const today = new Date();
  const due = inv.dueDate ? new Date(inv.dueDate) : null;
  const sk = inv.skontoDate ? new Date(inv.skontoDate) : null;
  const { rest } = computeTotals(inv);

  if (inv.paid || rest <= 0) return "paid";
  if (due && due < today) return "overdue";
  if (sk && sk >= today) return "skonto";
  return "open";
}

function getFilteredList(list) {
  const q = search.value.toLowerCase();

  return list.filter(inv => {
    const status = getStatus(inv);

    if (currentStatusFilter !== "all" && status !== currentStatusFilter) {
      return false;
    }

    if (supplierFilter && inv.supplier !== supplierFilter) {
      return false;
    }

    if (q) {
      const text =
        (inv.number || "") +
        " " +
        (inv.supplier || "") +
        " " +
        (inv.note || "");
      if (!text.toLowerCase().includes(q)) return false;
    }

    return true;
  });
}

/* =====================================================
   TABLE RENDERING
===================================================== */
function updateUI() {
  const list = loadInvoices();

  renderSuppliers(list);
  renderSupplierDatalist(list);
  renderSupplierTotals(list);

  if (list.length === 0) {
    tableBody.innerHTML =
      '<tr><td colspan="13" class="empty-state">Noch keine Rechnungen üíñ</td></tr>';
    sumOpen.textContent = "0 ‚Ç¨";
    sumOverdue.textContent = "0 ‚Ç¨";
    sumSkonto.textContent = "0 ‚Ç¨";
    return;
  }

  const filtered = getFilteredList(list);
  renderTable(filtered);
  renderSummary(list);
}

function renderTable(list) {
  if (list.length === 0) {
    tableBody.innerHTML =
      '<tr><td colspan="13" class="empty-state">Keine Rechnungen f√ºr den aktuellen Filter üßê</td></tr>';
    return;
  }

  let rows = "";

  list.forEach(inv => {
    const status = getStatus(inv);
    const { amount, creditTotal, rest } = computeTotals(inv);

    let rowClass = "row-open";
    let warn = "";

    if (status === "paid") {
      rowClass = "row-paid";
    } else if (status === "overdue") {
      rowClass = "row-overdue";
      warn = "‚ùó";
    } else if (status === "skonto") {
      rowClass = "row-skonto";
    }

    if (inv.inOB && !inv.paid && rest > 0) {
      rowClass += " row-ob";
    }

    if (creditTotal > 0) {
      rowClass += " row-credit";
    }

    const skAmount = inv.skontoPercent
      ? (amount * (inv.skontoPercent / 100)).toFixed(2)
      : "-";

    const dot =
      status === "paid" ? "‚úî" :
      status === "overdue" ? "‚ùó" :
      status === "skonto" ? "üíõ" :
      "üîµ";

    const obLabel = inv.inOB ? "üüß" : "";

    rows += `
      <tr class="${rowClass}">
        <td>${dot}</td>
        <td>${inv.number}</td>
        <td>${inv.supplier}</td>
        <td class="numeric">${amount.toFixed(2)}</td>
        <td class="numeric">${creditTotal > 0 ? creditTotal.toFixed(2) : "-"}</td>
        <td class="numeric rest-cell">${rest.toFixed(2)}</td>
        <td class="numeric">${inv.skontoPercent || "-"}</td>
        <td class="numeric">${skAmount}</td>
        <td>${inv.skontoDate || "-"}</td>
        <td>${inv.dueDate}</td>
        <td>${warn} ${obLabel}</td>
        <td>
          <input type="checkbox" data-id="${inv.id}" class="paidCheck" ${status === "paid" ? "checked" : ""}>
        </td>
        <td>
          <button class="btn small editBtn" data-id="${inv.id}">‚úèÔ∏è</button>
          <button class="btn small payBtn" data-id="${inv.id}">üí∂</button>
          <button class="btn small obBtn ${inv.inOB ? "active" : ""}" data-id="${inv.id}">üüß OB</button>
          <button class="btn small creditBtn" data-id="${inv.id}">‚ûñGS</button>
          <button class="btn small deleteBtn" data-id="${inv.id}">‚ùå</button>
        </td>
      </tr>
    `;
  });

  tableBody.innerHTML = rows;
  attachRowEvents();
}

/* =====================================================
   ROW EVENTS (PAID / EDIT / DELETE / TEILZAHLUNG / OB / GS)
===================================================== */
function attachRowEvents() {
  // Paid checkbox
  document.querySelectorAll(".paidCheck").forEach(cb => {
    cb.addEventListener("change", () => {
      const id = Number(cb.dataset.id);
      const list = loadInvoices();
      const inv = list.find(a => a.id === id);
      if (!inv) return;
      const { rest } = computeTotals(inv);
      inv.paid = cb.checked || rest <= 0;
      saveInvoices(list);
      updateUI();
    });
  });

  // Delete
  document.querySelectorAll(".deleteBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      if (!confirm("Rechnung wirklich l√∂schen?")) return;
      const id = Number(btn.dataset.id);
      let list = loadInvoices();
      list = list.filter(a => a.id !== id);
      saveInvoices(list);
      updateUI();
    });
  });

  // Edit
  document.querySelectorAll(".editBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = Number(btn.dataset.id);
      const list = loadInvoices();
      const inv = list.find(a => a.id === id);
      if (!inv) return;

      editId = id;
      document.getElementById("invoiceNumber").value = inv.number;
      document.getElementById("supplier").value = inv.supplier;
      document.getElementById("amount").value = inv.amount;
      document.getElementById("dueDate").value = inv.dueDate;
      document.getElementById("skontoPercent").value = inv.skontoPercent || "";
      document.getElementById("skontoDate").value = inv.skontoDate || "";
      document.getElementById("note").value = inv.note || "";

      saveButton.textContent = "Rechnung aktualisieren";
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  });

  // üí∂ Teilzahlungen
  document.querySelectorAll(".payBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = Number(btn.dataset.id);
      openPaymentPopup(id);
    });
  });

  // üüß OB (Onlinebanking)
  document.querySelectorAll(".obBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = Number(btn.dataset.id);
      const list = loadInvoices();
      const inv = list.find(a => a.id === id);
      if (!inv) return;
      inv.inOB = !inv.inOB;
      saveInvoices(list);
      updateUI();
    });
  });

  // ‚ûñ Gutschrift
  document.querySelectorAll(".creditBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = Number(btn.dataset.id);
      openCreditPopup(id);
    });
  });
}

/* =====================================================
   SUPPLIERS PANEL + SUMMEN
===================================================== */
function renderSuppliers(list) {
  const suppliers = [...new Set(list.map(a => a.supplier))];

  if (suppliers.length === 0) {
    supplierCards.innerHTML = "";
    return;
  }

  supplierCards.innerHTML = suppliers
    .map(
      (s) => `
    <div class="supplier-card ${
      supplierFilter === s ? "active" : ""
    }" data-supplier="${s}">${s}</div>
  `
    )
    .join("");

  document.querySelectorAll(".supplier-card").forEach((card) => {
    card.addEventListener("click", () => {
      const s = card.dataset.supplier;
      supplierFilter = supplierFilter === s ? null : s;
      updateUI();
    });
  });
}

function renderSupplierDatalist(list) {
  const suppliers = [...new Set(list.map(a => a.supplier))];
  supplierList.innerHTML = suppliers.map(s => `<option value="${s}"></option>`).join("");
}

function renderSupplierTotals(list) {
  if (!supplierFilter) {
    return;
  }

  const now = new Date();
  const filtered = list.filter(inv => inv.supplier === supplierFilter);

  let open = 0, overdue = 0, skonto = 0;

  filtered.forEach(inv => {
    const { rest } = computeTotals(inv);
    if (rest <= 0) return;

    open += rest;

    if (inv.dueDate && new Date(inv.dueDate) < now)
      overdue += rest;

    if (inv.skontoDate && new Date(inv.skontoDate) >= now)
      skonto += rest;
  });

  sumOpen.textContent = open.toFixed(2) + " ‚Ç¨";
  sumOverdue.textContent = overdue.toFixed(2) + " ‚Ç¨";
  sumSkonto.textContent = skonto.toFixed(2) + " ‚Ç¨";
}

/* =====================================================
   SUMMARIES (GESAMT)
===================================================== */
function renderSummary(list) {
  let open = 0, overdue = 0, skonto = 0;
  const now = new Date();

  list.forEach(inv => {
    const { rest } = computeTotals(inv);
    if (rest <= 0) return;

    open += rest;

    if (inv.dueDate && new Date(inv.dueDate) < now)
      overdue += rest;

    if (inv.skontoDate && new Date(inv.skontoDate) >= now)
      skonto += rest;
  });

  if (!supplierFilter) {
    sumOpen.textContent = open.toFixed(2) + " ‚Ç¨";
    sumOverdue.textContent = overdue.toFixed(2) + " ‚Ç¨";
    sumSkonto.textContent = skonto.toFixed(2) + " ‚Ç¨";
  }
}

/* =====================================================
   SUCHFELD + STATUSCHIPS
===================================================== */
search.addEventListener("input", () => updateUI());

statusChips.forEach(chip => {
  chip.addEventListener("click", () => {
    statusChips.forEach(c => c.classList.remove("active"));
    chip.classList.add("active");
    currentStatusFilter = chip.dataset.status;
    updateUI();
  });
});

/* =====================================================
   POPUP BEIM LADEN WENN √úBERF√ÑLLIGE RECHNUNGEN EXISTIEREN
===================================================== */
window.addEventListener("load", () => {
  const list = loadInvoices();
  const now = new Date();

  const hasOverdue = list.some(inv => {
    const { rest } = computeTotals(inv);
    return !inv.paid &&
      rest > 0 &&
      inv.dueDate &&
      new Date(inv.dueDate) < now;
  });

  if (hasOverdue) {
    alert("‚ö†Ô∏è Achtung!\nEs gibt √ºberf√§llige Rechnungen!");
  }

  updateUI();
});

/* =====================================================
   TEILZAHLUNGEN ‚Äì LOGIK
===================================================== */
function openPaymentPopup(invoiceId) {
  currentPaymentInvoice = invoiceId;
  const list = loadInvoices();
  const inv = list.find(x => x.id === invoiceId);

  if (!inv) return;
  if (!inv.payments) inv.payments = [];

  let html = "";
  if (inv.payments.length === 0) {
    html = "<p>Noch keine Teilzahlungen.</p>";
  } else {
    html = inv.payments.map(p => `
      <div style="padding:8px;border:1px solid #ccc;border-radius:8px;margin-bottom:8px;">
        <strong>${p.date}</strong> ‚Äì ${p.amount.toFixed(2)} ‚Ç¨
        <br><small>${p.note || ""}</small>
      </div>
    `).join("");
  }

  document.getElementById("paymentList").innerHTML = html;
  document.getElementById("paymentPopup").style.display = "flex";
}

document.getElementById("closePaymentPopup").addEventListener("click", () => {
  document.getElementById("paymentPopup").style.display = "none";
});

document.getElementById("addPaymentBtn").addEventListener("click", () => {
  const date = document.getElementById("payDate").value;
  const amount = parseFloat(document.getElementById("payAmount").value);
  const note = document.getElementById("payNote").value;

  if (!date || isNaN(amount) || amount <= 0) {
    alert("Bitte Datum und Betrag eingeben.");
    return;
  }

  const list = loadInvoices();
  const inv = list.find(x => x.id === currentPaymentInvoice);

  if (!inv) return;
  if (!inv.payments) inv.payments = [];

  inv.payments.push({
    date,
    amount,
    note
  });

  const { rest } = computeTotals(inv);
  if (rest <= 0) inv.paid = true;

  saveInvoices(list);
  updateUI();
  openPaymentPopup(currentPaymentInvoice);
});

/* =====================================================
   GUTSCHRIFTEN ‚Äì LOGIK
===================================================== */
function openCreditPopup(invoiceId) {
  currentCreditInvoice = invoiceId;
  const list = loadInvoices();
  const inv = list.find(x => x.id === invoiceId);

  if (!inv) return;
  if (!inv.credits) inv.credits = [];

  let html = "";
  if (inv.credits.length === 0) {
    html = "<p>Noch keine Gutschriften.</p>";
  } else {
    html = inv.credits.map(c => `
      <div style="padding:8px;border:1px solid #ccc;border-radius:8px;margin-bottom:8px;">
        <strong>${c.date}</strong> ‚Äì ${c.amount.toFixed(2)} ‚Ç¨
        <br><small>${c.note || ""}</small>
      </div>
    `).join("");
  }

  document.getElementById("creditList").innerHTML = html;
  document.getElementById("creditPopup").style.display = "flex";
}

document.getElementById("closeCreditPopup").addEventListener("click", () => {
  document.getElementById("creditPopup").style.display = "none";
});

document.getElementById("addCreditBtn").addEventListener("click", () => {
  const date = document.getElementById("creditDate").value;
  const amount = parseFloat(document.getElementById("creditAmount").value);
  const note = document.getElementById("creditNote").value;

  if (!date || isNaN(amount) || amount <= 0) {
    alert("Bitte Datum und Betrag eingeben.");
    return;
  }

  const list = loadInvoices();
  const inv = list.find(x => x.id === currentCreditInvoice);

  if (!inv) return;
  if (!inv.credits) inv.credits = [];

  inv.credits.push({
    date,
    amount,
    note
  });

  const { rest } = computeTotals(inv);
  if (rest <= 0) inv.paid = true;

  saveInvoices(list);
  updateUI();
  openCreditPopup(currentCreditInvoice);
});
</script>

</body>
</html>
